{"version":3,"file":"wording-library.mjs","sources":["../../../projects/wording-library/src/lib/wording-library.config.ts","../../../projects/wording-library/src/lib/wording-cache.service.ts","../../../projects/wording-library/src/lib/wording-library.service.ts","../../../projects/wording-library/src/lib/wording-custom-loader.ts","../../../projects/wording-library/src/lib/wording-library.module.ts","../../../projects/wording-library/src/public-api.ts","../../../projects/wording-library/src/wording-library.ts"],"sourcesContent":["import { InjectionToken } from \"@angular/core\";\r\n\r\nexport interface WordingLibraryConfig{\r\n    baseUrl:string;\r\n    fileConfigVersion:string;\r\n}\r\n\r\nexport const WORDING_LIBRARY_CONFIG = new InjectionToken<WordingLibraryConfig>('WORDING_LIBRARY_CONFIG');","import { Injectable } from '@angular/core';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class WordingCacheService<T> {\r\n\r\n  constructor() { }\r\n\r\n  private cache = new Map<string, T>();\r\n\r\n  get(key: string): T | null {\r\n    return this.cache.has(key) ? this.cache.get(key)! : null;\r\n  }\r\n\r\n  set(key: string, value: T): void {\r\n    this.cache.set(key, value);\r\n  }\r\n\r\n  has(key: string): boolean {\r\n    return this.cache.has(key);\r\n  }\r\n\r\n  clear(key?: string): void {\r\n    if (key) this.cache.delete(key);\r\n    else this.cache.clear();\r\n  }\r\n}\r\n","import { HttpClient } from '@angular/common/http';\nimport { Inject, Injectable } from '@angular/core';\nimport { TranslateService } from '@ngx-translate/core';\nimport { WORDING_LIBRARY_CONFIG, WordingLibraryConfig } from './wording-library.config';\nimport { lastValueFrom } from 'rxjs';\nimport { WordingCacheService } from './wording-cache.service';\n\n@Injectable({\n  providedIn: 'root'\n})\nexport class WordingLibraryService {\n\n  constructor(\n    private http: HttpClient,\n    private translate: TranslateService,\n    private memoryCache: WordingCacheService<string>,\n    @Inject(WORDING_LIBRARY_CONFIG) private config: WordingLibraryConfig\n  ) {}\n\n  // async initVersionCheck(): Promise<boolean> {\n  //     const baseUrl = this.config.baseUrl;\n  //     try {\n    \n  //       const serverVersions = await lastValueFrom(\n  //         this.http.get<Record<string, string>>(`${baseUrl}/${this.config.fileConfigVersion}.json`)\n  //       );\n    \n  //       let hasNewVersion = false;\n    \n  //       for (const lang of Object.keys(serverVersions)) {\n    \n  //         const localV = localStorage.getItem(`translations_version_${lang}`);\n  //         const serverV = serverVersions[lang];\n    \n  //         console.log(`Lang=${lang} | local=${localV} | server=${serverV}`);\n    \n  //         if (localV !== serverV) {\n    \n  //           hasNewVersion = true;\n  \n  //           localStorage.removeItem(`translations_${lang}`);\n  //           localStorage.setItem(`translations_version_${lang}`, serverV);\n    \n  //           await lastValueFrom(this.translate.reloadLang(lang));\n    \n  //           const current = this.translate.currentLang || this.translate.defaultLang;\n    \n  //           if (current === lang) {\n  //             await lastValueFrom(this.translate.use(lang));\n  //           }\n  //         }\n  //       }\n    \n  //       return hasNewVersion;\n    \n  //     } catch (error) {\n  //       console.error('Impossible de vérifier les versions', error);\n  //       return false;\n  //     }\n  //   }\n\n    async initVersionCheck(): Promise<boolean> {\n      \n        try {\n          const serverVersions = await lastValueFrom(\n            this.http.get<Record<string, string>>(`${this.config.baseUrl}/${this.config.fileConfigVersion}.json`)\n          );\n      \n          let hasNewVersion = false;\n      \n          const currentLang = this.translate.currentLang || this.translate.defaultLang;\n      \n          for (const lang of Object.keys(serverVersions)) {\n      \n            const localV = this.memoryCache.get(`translations_version_${lang}`);\n            const serverV = serverVersions[lang];\n      \n            if (localV !== serverV) {\n      \n              hasNewVersion = true;\n      \n              // Invalidation cache mémoire\n              this.memoryCache.clear(`translations_${lang}`);\n      \n              // Mise à jour version en mémoire\n              this.memoryCache.set(`translations_version_${lang}`, serverV);\n      \n              // Reload seulement si la langue active a changé\n              if (currentLang === lang) {\n                await lastValueFrom(this.translate.reloadLang(lang));\n                //await lastValueFrom(this.translate.use(lang));\n              }\n            }\n          }\n      \n          return hasNewVersion;\n      \n        } catch (error) {\n          console.error('Impossible de vérifier les versions', error);\n          return false;\n        }\n      }\n\n}\n","import { HttpClient } from \"@angular/common/http\";\r\nimport { TranslateLoader } from \"@ngx-translate/core\"\r\nimport { map, Observable, of, tap } from \"rxjs\";\r\nimport { Inject } from \"@angular/core\";\r\nimport { WordingLibraryConfig } from \"./wording-library.config\";\r\nimport { WordingCacheService } from \"./wording-cache.service\";\r\n\r\n\r\nexport type TranslationTree = {\r\n  [key: string]: string | TranslationTree;\r\n};\r\n\r\nexport class WordingCustomLoader implements TranslateLoader {\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    private config: WordingLibraryConfig,\r\n    private cache: WordingCacheService<TranslationTree>\r\n  ) {}\r\n\r\n  getTranslation(lang: string): Observable<TranslationTree> {\r\n    const key = `translations_${lang}`;\r\n\r\n    const cached = this.cache.get(key);\r\n    if (cached) {\r\n      return of(cached);\r\n    }\r\n\r\n    return this.http\r\n      .get<TranslationTree>(`${this.config.baseUrl}/${lang}.json`)\r\n      .pipe(\r\n        tap(translations => this.cache.set(key, translations))\r\n      );\r\n  }\r\n}\r\n","import { APP_INITIALIZER, ModuleWithProviders, NgModule } from '@angular/core';\nimport { WordingLibraryComponent } from './wording-library.component';\nimport { HttpClientModule } from '@angular/common/http';\nimport { WORDING_LIBRARY_CONFIG, WordingLibraryConfig } from './wording-library.config';\nimport { WordingLibraryService } from './wording-library.service';\n\nexport function initWording(service: WordingLibraryService) {\n  return () => service.initVersionCheck();\n}\n\n@NgModule({\n  declarations: [\n    \n  ],\n  imports: [\n    HttpClientModule\n  ],\n  exports: [\n    \n  ]\n})\nexport class WordingLibraryModule {\n\n  static forRoot(config: WordingLibraryConfig): ModuleWithProviders<WordingLibraryModule> {\n    return {\n      ngModule: WordingLibraryModule,\n      providers: [\n        { provide: WORDING_LIBRARY_CONFIG, useValue: config },\n        WordingLibraryService,\n        {\n          provide: APP_INITIALIZER,\n          useFactory: initWording,\n          deps: [WordingLibraryService],\n          multi: true\n        }\n      ]\n    };\n  }\n\n }\n","/*\n * Public API Surface of wording-library\n */\n\nexport * from './lib/wording-library.service';\nexport * from './lib/wording-library.config';\nexport * from './lib/wording-custom-loader'\nexport * from './lib/wording-library.module';\nexport * from './lib/wording-cache.service';\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './public-api';\n"],"names":[],"mappings":"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"}